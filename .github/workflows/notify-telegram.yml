name: Telegram Notify

on: push

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Send to Telegram
        run: |
          escape() {
            echo "$1" | sed 's/\\/\\\\/g' | sed 's/_/\\_/g' | sed 's/\*/\\*/g' | sed 's/\[/\\[/g' | sed 's/\]/\\]/g' | sed 's/(/\\(/g' | sed 's/)/\\)/g' | sed 's/~/\\~/g' | sed 's/`/\\`/g' | sed 's/>/\\>/g' | sed 's/#/\\#/g' | sed 's/+/\\+/g' | sed 's/=/\\=/g' | sed 's/|/\\|/g' | sed 's/{/\\{/g' | sed 's/}/\\}/g' | sed 's/\./\\./g' | sed 's/!/\\!/g' | sed 's/-/\\-/g'
          }

          # Get the comparison URL for all changes in this push
          COMPARE_URL="${{ github.event.compare }}"

          # Build commit list
          COMMITS=""
          COMMIT_COUNT=$(echo '${{ toJson(github.event.commits) }}' | jq length)

          echo '${{ toJson(github.event.commits) }}' | jq -r '.[] | "â€¢ `\(.id[0:7])` \(.message | split("\n")[0])"' | while IFS= read -r line; do
            COMMITS="${COMMITS}$(escape "$line")
          "
          done

          # Read commits into variable properly
          COMMITS=$(echo '${{ toJson(github.event.commits) }}' | jq -r '.[] | "â€¢ `" + .id[0:7] + "` " + (.message | split("\n")[0])')
          ESCAPED_COMMITS=$(echo "$COMMITS" | while IFS= read -r line; do escape "$line"; done | tr '\n' '\n')

          MSG="ðŸ”” *$(escape "${{ github.repository }}")*

          ðŸ‘¤ $(escape "${{ github.actor }}")
          ðŸŒ¿ $(escape "${{ github.ref_name }}")
          ðŸ“¦ ${COMMIT_COUNT} commit(s)

          ${ESCAPED_COMMITS}

          [View Changes](${COMPARE_URL})"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MSG" \
            -d parse_mode="MarkdownV2"
