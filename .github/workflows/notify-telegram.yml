name: Telegram Notify

on:
  workflow_call:
    secrets:
      TELEGRAM_TOKEN:
        required: true
      TELEGRAM_CHAT_ID:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Send to Telegram
        run: |
          escape() {
            echo "$1" | sed 's/\\/\\\\/g' | sed 's/_/\\_/g' | sed 's/\*/\\*/g' | sed 's/\[/\\[/g' | sed 's/\]/\\]/g' | sed 's/(/\\(/g' | sed 's/)/\\)/g' | sed 's/~/\\~/g' | sed 's/`/\\`/g' | sed 's/>/\\>/g' | sed 's/#/\\#/g' | sed 's/+/\\+/g' | sed 's/=/\\=/g' | sed 's/|/\\|/g' | sed 's/{/\\{/g' | sed 's/}/\\}/g' | sed 's/\./\\./g' | sed 's/!/\\!/g' | sed 's/-/\\-/g'
          }

          # Get the comparison URL for all changes in this push
          COMPARE_URL="${{ github.event.compare }}"

          # Build commit list with proper escaping
          COMMIT_COUNT=$(echo '${{ toJson(github.event.commits) }}' | jq length)

          ESCAPED_COMMITS=""
          while IFS= read -r line; do
            HASH=$(echo "$line" | jq -r '.id[0:7]')
            MESSAGE=$(echo "$line" | jq -r '.message | split("\n")[0]')
            COMMIT_URL=$(echo "$line" | jq -r '.url')
            ESCAPED_COMMITS="${ESCAPED_COMMITS}â€¢ [\`$(escape "$HASH")\`](${COMMIT_URL}) $(escape "$MESSAGE")
          "
          done < <(echo '${{ toJson(github.event.commits) }}' | jq -c '.[]')

          MSG="ðŸ”” *$(escape "${{ github.repository }}")*
          ðŸ‘¤ $(escape "${{ github.actor }}")
          ðŸŒ¿ $(escape "${{ github.ref_name }}")
          ðŸ“¦ ${COMMIT_COUNT} commit\\(s\\)

          ${ESCAPED_COMMITS}
          [View Changes](${COMPARE_URL})"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MSG" \
            -d parse_mode="MarkdownV2"
